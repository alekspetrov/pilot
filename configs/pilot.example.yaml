# Pilot Configuration
# Copy this to ~/.pilot/config.yaml and customize

version: "1.0"

# Gateway server settings
gateway:
  host: "127.0.0.1"
  port: 9090

# Authentication
auth:
  type: "claude-code"  # "claude-code" (local) or "api-token" (remote)
  # token: "sk-ant-..."  # Required if type is "api-token"
  # ANTHROPIC_API_KEY env var enables Claude API features (Haiku subtask parsing, etc.)

# Adapters
adapters:
  # Telegram - Chat-based task execution
  telegram:
    enabled: false
    bot_token: "${TELEGRAM_BOT_TOKEN}"
    chat_id: "${TELEGRAM_CHAT_ID}"    # Your user/chat ID for notifications
    transcription:
      provider: openai
      openai_key: "${OPENAI_API_KEY}"  # For voice message transcription
    # LLM-based intent classification (uses Claude Haiku for accurate intent detection)
    llm_classifier:
      enabled: false                   # Enable for better intent detection vs regex
      # api_key: ""                    # Optional - uses ANTHROPIC_API_KEY env var if not set
      timeout_seconds: 2               # Max time for classification
      history_size: 10                 # Messages to keep per chat for context
      history_ttl: 30m                 # TTL for conversation history
    # Rate limiting to prevent abuse
    rate_limit:
      enabled: true
      requests_per_minute: 30
      burst: 5

  # GitHub - Issue polling and PR creation
  github:
    enabled: false
    token: "${GITHUB_TOKEN}"
    repo: "owner/repo"                 # Repository to poll
    pilot_label: "pilot"               # Issues with this label are picked up
    polling:
      enabled: true
      interval: 30s
      label: "pilot"

  # GitLab - Issue polling and MR creation
  gitlab:
    enabled: false
    token: "${GITLAB_TOKEN}"
    base_url: "https://gitlab.com"     # Or self-hosted instance URL
    project: "namespace/project"       # Project path
    pilot_label: "pilot"               # Issues with this label are picked up
    webhook_secret: "${GITLAB_WEBHOOK_SECRET}"
    polling:
      enabled: true
      interval: 30s
      label: "pilot"
    stale_label_cleanup:
      enabled: true
      interval: 30m
      threshold: 1h

  # Azure DevOps - Work item polling and PR creation
  azure_devops:
    enabled: false
    pat: "${AZURE_DEVOPS_PAT}"         # Personal Access Token
    organization: "my-org"             # Azure DevOps organization
    project: "my-project"              # Project name
    repository: "my-repo"              # Repository name (optional, defaults to project)
    base_url: "https://dev.azure.com"  # Or Azure DevOps Server URL
    pilot_tag: "pilot"                 # Work items with this tag are picked up
    webhook_secret: "${AZURE_DEVOPS_WEBHOOK_SECRET}"
    work_item_types:                   # Which work item types to process
      - "Bug"
      - "Task"
      - "User Story"
    polling:
      enabled: true
      interval: 30s
    stale_label_cleanup:
      enabled: true
      interval: 30m
      threshold: 1h

  # Linear - Issue tracking (webhooks)
  linear:
    enabled: false
    api_key: "${LINEAR_API_KEY}"
    team_id: "your-team-id"
    pilot_label: "pilot"    # Issues with this label are picked up
    auto_assign: true        # Auto-assign issues to Pilot

  # Slack - Notifications
  slack:
    enabled: false
    bot_token: "${SLACK_BOT_TOKEN}"
    channel: "#dev-notifications"

# Orchestrator settings
orchestrator:
  model: "claude-opus-4-6"
  max_concurrent: 2          # Max parallel tasks

  # Execution mode (auto, sequential, or parallel)
  execution:
    mode: "auto"               # auto (default): parallel dispatch with scope-overlap guard
                               #   non-overlapping issues run concurrently; overlapping groups
                               #   run oldest-first (safe against merge conflicts)
                               # sequential: one issue at a time, waits for PR merge
                               # parallel: all issues run concurrently (legacy, no overlap guard)
    wait_for_merge: true       # Wait for PR merge before picking next issue (sequential only)
    poll_interval: 30s         # How often to check PR status
    pr_timeout: 1h             # Max time to wait for PR merge

# Executor settings
executor:
  type: "claude-code"          # "claude-code" or "opencode"
  auto_create_pr: true         # Create PR by default after task completion
                               # Use --no-pr flag to disable for individual tasks
  # direct_commit: false       # DANGER: Enable direct commit to main (requires --direct-commit flag)
                               # When enabled with flag, skips branches and PRs, pushes directly to main
                               # Intended for users who rely on manual QA instead of code review

  # Worktree isolation - execute tasks in temporary git worktree
  # use_worktree: false        # When true, creates isolated worktree per task
                               # Allows execution even with uncommitted changes in working directory
                               # Useful when Pilot runs in same repo as your development work

  # Effort routing (Opus 4.6) - controls how thoroughly Claude reasons per complexity
  # effort_routing:
  #   enabled: true
  #   trivial: "low"             # Fast, minimal token spend
  #   simple: "medium"           # Balanced
  #   medium: "high"             # Standard (default behavior)
  #   complex: "max"             # Deepest reasoning (Opus 4.6 only)

  # Model routing - select model by task complexity
  # model_routing:
  #   enabled: true
  #   trivial: "claude-haiku"           # Typos, renames ($1/$5 per MTok)
  #   simple: "claude-sonnet-4-6"       # Small fixes, config ($3/$15 per MTok)
  #   medium: "claude-sonnet-4-6"       # Features, endpoints ($3/$15 per MTok)
  #   complex: "claude-opus-4-6"        # Refactors, migrations ($5/$25 per MTok)

  # Smart retry (GH-920) - retry on transient errors with backoff
  # retry:
  #   enabled: true
  #   rate_limit:                 # Rate limit errors (429, quota exceeded)
  #     max_attempts: 3
  #     initial_backoff: 30s      # 30s, 60s, 120s
  #     backoff_multiplier: 2.0
  #   api_error:                  # API errors (auth, server errors)
  #     max_attempts: 3
  #     initial_backoff: 5s       # 5s, 10s, 20s
  #     backoff_multiplier: 2.0
  #   timeout:                    # Timeout errors
  #     max_attempts: 2           # Retry once
  #     extend_timeout: true      # Use 1.5x original timeout on retry
  #     timeout_multiplier: 1.5
  # Note: invalid_config errors always fail fast (no retry)

  # Stagnation detection (GH-925) - detect and recover from stuck tasks
  # stagnation:
  #   enabled: true
  #   warn_timeout: 10m           # Warn after 10 minutes
  #   pause_timeout: 20m          # Pause after 20 minutes
  #   abort_timeout: 30m          # Abort after 30 minutes
  #   warn_at_iteration: 8        # Warn after 8 Claude turns
  #   pause_at_iteration: 12      # Pause after 12 turns
  #   abort_at_iteration: 15      # Abort after 15 turns
  #   state_history_size: 5       # Track last 5 states for loop detection
  #   identical_states_threshold: 3  # 3 identical states = loop detected
  #   grace_period: 30s           # Grace period before killing
  #   commit_partial_work: true   # Save partial progress before abort

# Daily briefs configuration
briefs:
  enabled: false
  schedule: "0 9 * * 1-5"      # Cron: 9 AM weekdays
  timezone: "America/New_York"
  channels:
    # Slack channel
    - type: slack
      channel: "#dev-updates"
    # Telegram chat
    - type: telegram
      channel: "${TELEGRAM_CHAT_ID}"  # Your Telegram chat ID
    # Email recipients
    # - type: email
    #   recipients:
    #     - team@example.com
  content:
    include_metrics: true
    include_errors: true
    max_items_per_section: 10

# Memory settings
memory:
  path: "~/.pilot/data"
  cross_project: true        # Share learnings across projects
  learning:
    enabled: true             # Enable pattern learning system
    min_confidence: 0.6       # Min confidence for prompt injection
    max_patterns: 5           # Max patterns injected per task
    include_anti: true        # Include anti-patterns in prompts

# Project configurations
projects:
  # Example project
  - name: "my-app"
    path: "/path/to/my-app"
    navigator: true           # Use Navigator for context efficiency
    default_branch: "main"
    # GitHub integration for PR creation
    # github:
    #   owner: "my-org"
    #   repo: "my-app"
    # Linear project pairing (GH-1684) - maps Linear project to this Pilot project
    # Precedence: project-level linear.project_id > workspace-level > default_project
    # linear:
    #   project_id: "proj-abc123"   # Linear project UUID

# Autopilot settings
autopilot:
  enabled: false
  # Default environment used when --env is not specified (default: stage)
  default_environment: "stage"
  # Global autopilot settings
  auto_merge: true
  merge_method: "squash"
  ci_wait_timeout: 30m
  ci_poll_interval: 30s
  approval_source: "telegram"   # telegram, slack, or github-review

  # Define named environment configurations
  # Each environment can have different branch, approval, and CI settings
  environments:
    # Development environment: fast feedback, auto-merge
    dev:
      branch: develop
      require_approval: false
      ci_timeout: 5m
      skip_post_merge_ci: true
      post_merge:
        action: "none"

    # Staging environment: wait for CI, then auto-merge
    staging:
      branch: staging
      require_approval: false
      ci_timeout: 30m
      skip_post_merge_ci: false
      post_merge:
        action: "none"

    # Production environment: requires human approval
    prod:
      branch: main
      require_approval: true
      approval_source: "telegram"
      approval_timeout: 1h
      ci_timeout: 30m
      skip_post_merge_ci: false
      merge_method: "squash"
      post_merge:
        action: "tag"
        # For webhook action:
        # webhook_url: "https://example.com/deploy"
        # webhook_secret: "${DEPLOY_WEBHOOK_SECRET}"

  # Approval configuration (per-environment override possible)
  github_review:
    poll_interval: 30s

  # CI Check Discovery (v0.34+)
  ci_checks:
    mode: auto                    # auto | manual (default: auto)
    exclude:                      # Check names to ignore in auto mode
      - "codecov/*"              # Glob patterns supported
      - "*-optional"
    # required: []                # Only used in manual mode
    discovery_grace_period: 60s   # Wait for CI to start

# Dashboard settings
dashboard:
  refresh_interval: 1000     # ms
  show_logs: true
