import { Callout, Steps } from 'nextra/components'

# Setup

Context intelligence activates automatically when Pilot detects a `.agent/` directory in your project.
Since v0.33.16, Pilot auto-initializes the `.agent/` directory on first task execution ‚Äî no manual setup required.

<Callout type="info">
  For most projects, context intelligence works out of the box. Pilot creates the `.agent/`
  directory automatically when it runs its first task. Manual setup is only needed for
  customizing the documentation structure.
</Callout>

## Prerequisites

- **Pilot** installed and configured (`pilot doctor` passes)
- **Claude Code** (or Qwen Code / OpenCode) installed
- A project repository with at least one commit

## Auto-Initialization (Default)

When Pilot executes its first task in a project, it automatically creates the `.agent/` directory
with a default `DEVELOPMENT-README.md`. This is sufficient for most projects.

```bash
# Just run a task ‚Äî .agent/ is created automatically
pilot task "Add health check endpoint"
```

The auto-generated index includes your project structure, detected framework, and component status.

## Custom Setup

For projects that need a tailored context structure, initialize manually:

<Steps>

### Create the directory structure

```bash
mkdir -p .agent/system .agent/tasks .agent/memories .agent/sops .agent/.context-markers
```

This creates the standard layout:

```
.agent/
‚îú‚îÄ‚îÄ DEVELOPMENT-README.md     # Index document (loaded every session)
‚îú‚îÄ‚îÄ system/                    # Architecture and system docs
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md        # System design, data flow
‚îÇ   ‚îú‚îÄ‚îÄ FEATURE-MATRIX.md      # What's implemented vs planned
‚îÇ   ‚îî‚îÄ‚îÄ PR-CHECKLIST.md        # Pre-merge verification
‚îú‚îÄ‚îÄ tasks/                     # Task implementation plans
‚îÇ   ‚îî‚îÄ‚îÄ archive/               # Completed task docs
‚îú‚îÄ‚îÄ memories/                  # Knowledge graph entries
‚îú‚îÄ‚îÄ sops/                      # Standard Operating Procedures
‚îî‚îÄ‚îÄ .context-markers/          # Session save points
```

### Write the index document

Create `.agent/DEVELOPMENT-README.md` ‚Äî this is the only file loaded at session
start. Keep it under **500 words** (~2k tokens).

```markdown
# Project Name ‚Äî Development Context

## Quick Navigation

| Document | When to Read |
|----------|-------------|
| This file | Every session (auto-loaded) |
| `system/ARCHITECTURE.md` | System design, data flow |
| `system/FEATURE-MATRIX.md` | What's implemented vs not |
| `tasks/TASK-XX.md` | Active task details |

## Current State

**Version:** v1.0.0

### Key Components

| Component | Status | Notes |
|-----------|--------|-------|
| API Server | Working | Express + TypeScript |
| Database | Working | PostgreSQL + Prisma |
| Auth | In Progress | JWT-based |

## Project Structure

\`\`\`
project/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/          # Route handlers
‚îÇ   ‚îú‚îÄ‚îÄ services/     # Business logic
‚îÇ   ‚îî‚îÄ‚îÄ models/       # Database models
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ .agent/           # Context docs
\`\`\`

## Active Work

_See GitHub Issues with `pilot` label for current queue._
```

### Configure CLAUDE.md

Add context intelligence instructions to your project's `CLAUDE.md`:

```markdown
## Context Intelligence

This project uses structured context management.
Documentation lives in `.agent/`.

### Quick Commands
- `/nav-start` ‚Äî Start or resume context session
- `/nav-task "description"` ‚Äî Plan a new task
- `/nav-compact` ‚Äî Clear context when done with a task
```

### Verify the setup

Run Pilot to confirm detection:

```bash
pilot task --dry-run "Test context detection"
```

The output should include:

```
üß≠ Context: ‚úì detected (.agent/ exists)
```

If you see `‚ö†Ô∏è Context: not found`, check that `.agent/DEVELOPMENT-README.md` exists.

</Steps>

## Directory Reference

### `DEVELOPMENT-README.md` (Required)

The index document. Loaded every session. Contains:
- Quick navigation table linking to other docs
- Current project state and version
- Key component status
- Project structure overview
- Active work references

**Target size:** Under 500 words (~2,000 tokens).

### `system/` (Recommended)

Architecture and system-level documentation:

| File | Purpose |
|------|---------|
| `ARCHITECTURE.md` | System design, data flow, package map |
| `FEATURE-MATRIX.md` | Implementation status of all features |
| `PR-CHECKLIST.md` | Pre-merge verification steps |

These are loaded on demand when tasks touch architecture.

### `tasks/` (Recommended)

Task implementation plans created by `/nav-task`. Each task gets a markdown file with:
- Requirements analysis
- Implementation steps
- Affected files
- Test plan
- Post-completion archive with learnings

Completed tasks move to `tasks/archive/`.

### `memories/` (Optional)

Knowledge graph entries ‚Äî decisions, patterns, and pitfalls captured during development.
The context engine creates and queries these automatically.

### `sops/` (Optional)

Standard Operating Procedures for recurring workflows:
- Release process
- Integration testing
- Deployment steps

### `.context-markers/` (Auto-managed)

Session save points created by the context engine. Do not manually edit these files.
Format: `YYYY-MM-DD-HHMM_description.md`

### `.nav-config.json` (Optional)

Context engine configuration overrides:

```json
{
  "version": "6.1.0",
  "features": {
    "knowledge_graph": true,
    "user_profile": true,
    "loop_mode": true
  }
}
```

### `.user-profile.json` (Auto-managed)

User preferences learned by the bilateral modeling system:

```json
{
  "verbosity": "concise",
  "confirmation_threshold": "low",
  "framework_preferences": ["Go", "TypeScript"],
  "correction_patterns": []
}
```

## Configuration in `config.yaml`

Enable context intelligence per project in your Pilot configuration:

```yaml
# ~/.pilot/config.yaml
projects:
  - name: "my-project"
    path: "/path/to/project"
    navigator: true    # Pilot checks for .agent/ before each task
```

When `navigator: true`, Pilot will activate context intelligence
if `.agent/` exists in the project path.

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| `Context: not found` in output | Missing `.agent/` directory | Run `mkdir -p .agent` and create index |
| Context engine loads but burns tokens | Index document too large | Keep `DEVELOPMENT-README.md` under 500 words |
| Knowledge graph empty | No memories captured yet | Memories accumulate automatically over tasks |
| Context markers missing | First session | Markers created when using `/nav-marker` or `/nav-compact` |
| Phase progress stuck | Context signals not detected | Verify execution backend is configured correctly |
