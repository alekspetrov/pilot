import { Callout } from 'nextra/components'

# Quality Gates

Quality gates enforce code quality standards between implementation and PR creation. They ensure all code passes basic checks before being submitted for review.

<Callout type="info">
  Quality gates run automatically after task implementation. If gates fail, Pilot receives feedback and retries the implementation.
</Callout>

<Callout type="warning">
  Quality gates are disabled by default (`enabled: false`). You must explicitly enable them in your configuration.
</Callout>

## Overview

Quality gates provide automated quality assurance by running checks like build verification, tests, linting, and security scans. When gates fail, the system provides specific error feedback to guide fixes.

### When Gates Run

```
Task Implementation → Quality Gates → Pass? → Create PR
                            ↓ Fail
                      Retry with feedback
                            ↓ Still fail
                      Notify & Stop
```

Gates execute in the project directory after code changes are complete but before PR creation. This catches issues early while providing actionable feedback for automatic fixes.

## Gate Types

Quality gates support seven built-in types with configurable commands and thresholds:

| Type | Default Timeout | Description |
|------|----------------|-------------|
| **build** | 5 minutes | Compilation and syntax checking |
| **test** | 10 minutes | Unit, integration, and e2e test execution |
| **lint** | 2 minutes | Code style, formatting, and static analysis |
| **coverage** | 10 minutes | Test coverage measurement and threshold enforcement |
| **security** | 5 minutes | Security vulnerability scanning |
| **typecheck** | 3 minutes | Type checking for TypeScript, Flow, or similar |
| **custom** | 5 minutes | Project-specific checks and validations |

### Build Gates

Verify code compiles and has no syntax errors. Auto-detects project type:

- **Go**: `go build ./...`
- **Node.js + TypeScript**: `npm run build || npx tsc --noEmit`
- **Rust**: `cargo check`
- **Python**: `python -m py_compile *.py`

### Test Gates

Execute test suites with configurable timeout. Common commands:

- `make test`
- `npm test`
- `go test ./...`
- `pytest`

### Lint Gates

Enforce code style and catch common issues:

- `make lint`
- `npm run lint`
- `golangci-lint run`
- `eslint .`

### Coverage Gates

Measure test coverage and enforce minimum thresholds. Supports parsing:

- **Go**: `go test -cover ./...`
- **Jest**: `npm test -- --coverage`
- **Python**: `pytest --cov=.`

Set `threshold: 80` to require 80% coverage.

### Security Gates

Scan for vulnerabilities and security issues:

- `npm audit`
- `go mod audit`
- `safety check` (Python)
- `cargo audit` (Rust)

### Type Check Gates

Verify type safety in typed languages:

- `npx tsc --noEmit` (TypeScript)
- `mypy .` (Python)
- `flow check` (Flow)

### Custom Gates

Run project-specific checks:

- Bundle size validation
- Performance benchmarks
- API contract verification
- Database migration validation

## Configuration

Enable quality gates in `~/.pilot/config.yaml`:

### Complete YAML Schema

```yaml
quality:
  # Enable quality gates (default: false)
  enabled: true

  # Gate definitions
  gates:
    - name: build           # Gate identifier (required)
      type: build           # Gate type: build, test, lint, coverage, security, typecheck, custom
      command: "make build" # Command to execute (required)
      required: true        # Fail pipeline if gate fails (default: false)
      timeout: 5m           # Max execution time (default varies by type)
      max_retries: 2        # Retry count on failure (default: 0)
      retry_delay: 5s       # Delay between retries (default: 0s)
      failure_hint: "Fix compilation errors in the changed files"  # Hint for Claude on failure

    - name: test
      type: test
      command: "make test"
      required: true
      timeout: 10m
      max_retries: 2
      retry_delay: 5s
      failure_hint: "Fix failing tests or update test expectations"

    - name: lint
      type: lint
      command: "make lint"
      required: false       # Warn only, don't fail pipeline
      timeout: 2m
      max_retries: 1
      retry_delay: 2s
      failure_hint: "Fix linting errors: formatting, unused imports, etc."

    - name: coverage
      type: coverage
      command: "go test -coverprofile=coverage.out ./... && go tool cover -func=coverage.out"
      required: true
      threshold: 80         # Minimum coverage percentage (0-100)
      timeout: 10m
      failure_hint: "Add tests to increase coverage above 80%"

    - name: security
      type: security
      command: "gosec ./..."
      required: false
      timeout: 5m
      failure_hint: "Address security vulnerabilities found by gosec"

  # Behavior when gates fail
  on_failure:
    action: retry           # retry | fail | warn
    max_retries: 2          # Max retry attempts before failing
    notify_on:              # Statuses that trigger notifications
      - failed
```

### Gate Properties

| Property | Description | Required |
|----------|-------------|----------|
| `name` | Unique gate identifier | ✓ |
| `type` | Gate type (build, test, etc.) | ✓ |
| `command` | Shell command to execute | ✓ |
| `required` | Fail pipeline if gate fails | |
| `timeout` | Maximum execution time | |
| `threshold` | Coverage percentage (coverage gates only) | |
| `max_retries` | Retry attempts on failure | |
| `retry_delay` | Delay between retries | |
| `failure_hint` | Guidance for Claude on failure | |

## Behavior

### Required vs Optional Gates

- **Required gates**: Pipeline fails if gate fails after retries
- **Optional gates**: Generate warnings but allow PR creation

### Retry Logic

Failed gates trigger automatic retries with:

1. **Error feedback**: Gate output is provided to Claude
2. **Failure hints**: Custom guidance for common issues
3. **Delay**: Configurable wait between attempts
4. **Max attempts**: Prevents infinite retry loops

### Failure Actions

Configure pipeline behavior when required gates fail:

- **retry**: Provide feedback and retry implementation (default)
- **fail**: Stop pipeline immediately
- **warn**: Log warning but continue to PR creation

## Minimal Configuration

For basic protection without full configuration:

```yaml
quality:
  enabled: true
  # Uses minimal build gate with auto-detection
```

This enables build verification only, with commands auto-detected from project type.

### Node.js/TypeScript Example

```yaml
quality:
  enabled: true
  gates:
    - name: typecheck
      type: typecheck
      command: "npx tsc --noEmit"
      required: true
      timeout: 3m
      failure_hint: "Fix TypeScript compilation errors"

    - name: lint
      type: lint
      command: "npm run lint"
      required: true
      timeout: 2m
      failure_hint: "Fix ESLint errors"

    - name: test
      type: test
      command: "npm test"
      required: true
      timeout: 10m
      max_retries: 1
      retry_delay: 3s
      failure_hint: "Fix failing tests"

    - name: build
      type: build
      command: "npm run build"
      required: true
      timeout: 5m
      failure_hint: "Fix build errors"

  on_failure:
    action: retry
    max_retries: 2
```

### Python Example

```yaml
quality:
  enabled: true
  gates:
    - name: typecheck
      type: typecheck
      command: "mypy src/"
      required: true
      timeout: 3m
      failure_hint: "Fix type errors found by mypy"

    - name: lint
      type: lint
      command: "ruff check ."
      required: true
      timeout: 2m
      failure_hint: "Fix linting errors from ruff"

    - name: format
      type: custom
      command: "ruff format --check ."
      required: false
      timeout: 1m
      failure_hint: "Run 'ruff format .' to fix formatting"

    - name: test
      type: test
      command: "pytest -v"
      required: true
      timeout: 10m
      max_retries: 1
      retry_delay: 3s
      failure_hint: "Fix failing tests"

  on_failure:
    action: retry
    max_retries: 2
```

## Monitoring

Quality gate results are logged and tracked:

```bash
# View recent gate results
pilot logs --quality

# Dashboard with gate status
pilot start --dashboard
```

## Best Practices

<Callout type="warning">
  Start with build and test gates only. Add linting and coverage gates gradually to avoid overwhelming the system with failures.
</Callout>

1. **Start simple**: Enable build gates first, add others incrementally
2. **Tune timeouts**: Adjust based on project size and CI performance
3. **Meaningful hints**: Provide specific guidance in `failure_hint`
4. **Optional first**: Make new gates optional until they're stable
5. **Test locally**: Verify gate commands work in your environment

## Troubleshooting

### Gates Always Failing

Check that gate commands work in your project:

```bash
# Test gate commands manually
make build
make test
make lint
```

### Timeout Issues

Increase timeout for slow operations:

```yaml
- name: integration-test
  timeout: 20m  # Longer for slow tests
```

### Coverage Parsing

Ensure coverage output format is supported. Quality gates parse:

- Go: `coverage: X.X% of statements`
- Jest: `All files | X.X |`
- Python: `TOTAL.*X%`