# GH-1870

**Created:** 2026-02-25

## Problem

GitHub Issue #1870: feat(autopilot): Wire board sync into controller with IssueNodeID in PRState

## Problem

The autopilot controller adds `pilot-done` label on PR merge and `pilot-failed` on CI failure, but has no board sync integration. The board card stays stale after autopilot processes a PR.

Missing pieces:
1. `PRState` has no `IssueNodeID` field
2. Controller has no `ProjectBoardSync` reference
3. Merge/fail paths don't call board sync

## Fix

### 1. Add `IssueNodeID` to `PRState` in `internal/autopilot/types.go`

```go
type PRState struct {
    // ... existing fields ...
    IssueNodeID string // GraphQL node ID for board sync
}
```

### 2. Add board sync to Controller in `internal/autopilot/controller.go`

Add field and functional option:

```go
type Controller struct {
    // ... existing fields ...
    boardSync  *github.ProjectBoardSync
    doneStatus string
    failStatus string
}

func WithProjectBoardSync(bs *github.ProjectBoardSync, doneStatus, failStatus string) ControllerOption {
    return func(c *Controller) {
        c.boardSync = bs
        c.doneStatus = doneStatus
        c.failStatus = failStatus
    }
}
```

### 3. Wire in merge handler

In `handleMerging` (where `AddLabels(LabelDone)` is called):

```go
if c.boardSync != nil && pr.IssueNodeID != "" {
    if err := c.boardSync.UpdateProjectItemStatus(ctx, pr.IssueNodeID, c.doneStatus); err != nil {
        slog.Warn("board sync on merge failed", "pr", pr.Number, "error", err)
    }
}
```

### 4. Wire in CI failure handler

In `handleCIFailed` (where `AddLabels(LabelFailed)` is called):

```go
if c.boardSync != nil && pr.IssueNodeID != "" && c.failStatus != "" {
    if err := c.boardSync.UpdateProjectItemStatus(ctx, pr.IssueNodeID, c.failStatus); err != nil {
        slog.Warn("board sync on CI fail failed", "pr", pr.Number, "error", err)
    }
}
```

### 5. Populate IssueNodeID at PRState creation

In `cmd/pilot/handlers.go` where `PRState` is created for autopilot (search for `OnPRCreated` callback or `PRState{`), add:

```go
IssueNodeID: issue.NodeID,
```

### 6. Wire option in `cmd/pilot/main.go`

Where `autopilot.NewController()` is called, add the option:

```go
if boardSync != nil {
    opts = append(opts, autopilot.WithProjectBoardSync(
        boardSync,
        cfg.Adapters.GitHub.ProjectBoard.GetStatuses().Done,
        cfg.Adapters.GitHub.ProjectBoard.GetStatuses().Failed,
    ))
}
```

## Acceptance Criteria

- [ ] `go build ./...` compiles
- [ ] `go test ./internal/autopilot/...` passes
- [ ] Board syncs to "Done" on autopilot merge
- [ ] Board syncs to "Failed" (if configured) on CI failure
- [ ] Nil-safe when boardSync is nil or IssueNodeID is empty
- [ ] No changes when `project_board` config is absent

## Acceptance Criteria

