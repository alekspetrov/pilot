# GH-1533: Fix Claude Code Hooks Format + Deduplication

**Status**: ðŸš§ In Progress
**Created**: 2026-02-18
**Issue**: https://github.com/alekspetrov/pilot/issues/1533
**Assignee**: Pilot

---

## Context

**Problem**:
`/doctor` reports all hooks in `.claude/settings.json` as invalid. Three bugs compound:
1. Matcher format is object (`{"tools":["Bash"]}`) but CC 2.1.44+ expects regex string (`"Bash"`)
2. No deduplication â€” unclean restarts accumulate duplicate hook entries
3. Defer-based restore doesn't fire on kill/crash â†’ stale hooks persist

**Goal**:
Pilot-managed hooks pass `/doctor` validation and don't accumulate across restarts.

**Success Criteria**:
- [ ] `/doctor` reports no hook format errors
- [ ] Repeated restarts don't accumulate duplicates
- [ ] Stale hooks from crashed sessions cleaned up on next start
- [ ] PreToolUse matcher is regex string `"Bash"`
- [ ] Stop hooks have no `matcher` field
- [ ] All existing tests pass

---

## Implementation Plan

### Phase 1: Fix Matcher Format
**Goal**: Emit correct JSON structure for CC 2.1.44+

**Tasks**:
- [ ] Change `HookMatcherEntry.Matcher` from `HookMatcher` struct to `string`
- [ ] For Stop hooks: use `json:"matcher,omitempty"` so empty string omits the field
- [ ] Update `GenerateClaudeSettings()` to set matcher to `"Bash"` for PreToolUse, `""` for Stop
- [ ] Remove or deprecate `HookMatcher` struct

**Files**:
- `internal/executor/hooks.go` â€” struct definitions (lines 60-80), generation (lines 89-157)

### Phase 2: Add Deduplication
**Goal**: Prevent duplicate hooks from accumulating

**Tasks**:
- [ ] In `mergeNewFormatHooks()`, before appending, extract script filename from command path
- [ ] Compare by filename (e.g., `pilot-bash-guard.sh`) â€” different temp dirs = same hook
- [ ] Skip append if duplicate found

**Files**:
- `internal/executor/hooks.go` â€” `mergeNewFormatHooks()` (lines 282-327)

### Phase 3: Add Stale Hook Cleanup
**Goal**: Remove hooks pointing to non-existent scripts before merging

**Tasks**:
- [ ] Add `cleanStaleHooks()` function that filters entries by checking if command path exists
- [ ] Identify Pilot hooks by path pattern (`pilot-hooks-*/pilot-*.sh`)
- [ ] Call cleanup before merge in `MergeWithExisting()`

**Files**:
- `internal/executor/hooks.go` â€” new function + call in `MergeWithExisting()` (line ~224)

### Phase 4: Update Tests
**Goal**: All tests reflect new format

**Tasks**:
- [ ] Update test expectations for string matcher format
- [ ] Add test for deduplication (merge same hook twice â†’ only one entry)
- [ ] Add test for stale cleanup (hook with non-existent script â†’ removed)
- [ ] Add test for Stop hook without matcher field in JSON output

**Files**:
- `internal/executor/hooks_test.go`

---

## Technical Decisions

| Decision | Options Considered | Chosen | Reasoning |
|----------|-------------------|--------|-----------|
| Matcher type | Keep struct with custom marshaler / Replace with string | Replace with string | Simpler, matches CC spec directly, no custom JSON logic |
| Stop matcher | Separate struct / omitempty on string | omitempty on string | Empty string + omitempty = field absent in JSON, cleanest approach |
| Dedup strategy | Full command comparison / Filename extraction | Filename extraction | Same script in different temp dirs is the same hook |
| Stale detection | Path pattern match / os.Stat existence check | Both: pattern match + existence check | Pattern identifies Pilot hooks, existence check confirms staleness |

---

## Root Cause Analysis

```
Pilot start â†’ MergeWithExisting() â†’ appends hooks to settings.json
    â†“
Pilot execution runs (hooks active)
    â†“
Pilot killed (kill -9, crash, Ctrl+C)
    â†“
defer hookRestoreFunc() NEVER FIRES
    â†“
settings.json retains stale hooks (pointing to now-deleted temp scripts)
    â†“
Next Pilot start â†’ MergeWithExisting() reads stale settings
    â†“
mergeNewFormatHooks() appends AGAIN (no dedup check)
    â†“
6 restarts = 6 duplicate entries, all with wrong matcher format
```

---

## Verify

```bash
# Run hook-specific tests
go test ./internal/executor/ -run TestHook -v

# Run all executor tests
go test ./internal/executor/ -v

# Build
make build

# Manual verification: start pilot, check settings.json, restart, check again
cat .claude/settings.json | jq '.hooks'
```

---

## Done

- [ ] `HookMatcherEntry.Matcher` is `string` type
- [ ] `GenerateClaudeSettings()` emits `"matcher": "Bash"` for PreToolUse
- [ ] Stop hooks have no `matcher` field in JSON
- [ ] `mergeNewFormatHooks()` deduplicates by script filename
- [ ] `MergeWithExisting()` cleans stale hooks before merging
- [ ] All tests pass including new dedup/stale/format tests
- [ ] `/doctor` shows clean after Pilot run

---

**Last Updated**: 2026-02-18
