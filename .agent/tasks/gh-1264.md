# GH-1264

**Created:** 2026-02-14

## Problem

GitHub Issue #1264: feat(executor): structured output for classifiers + post-execution summary

## Summary

Replace brittle text parsing in complexity/effort classifiers with Claude Code's `--json-schema` structured output. Add post-execution summary step to replace fragile `extractCommitSHA()` regex.

## Context

Claude Code v2.1.30 added `--output-format json --json-schema '<schema>'` which guarantees well-formed JSON output matching a schema. Currently:
- `complexity_classifier.go` uses `--output-format text` then strips markdown fences before JSON parse
- `effort_classifier.go` same pattern
- `extractCommitSHA()` uses regex `[branch sha]` to parse git commit output — fails when format doesn't match

## Implementation

### 1. New file: `internal/executor/structured_output.go`

Define JSON Schema constants and helper:

```go
// ClassificationSchema for complexity classifier
const ClassificationSchema = `{"type":"object","properties":{"complexity":{"type":"string","enum":["TRIVIAL","SIMPLE","MEDIUM","COMPLEX","EPIC"]},"reason":{"type":"string"}},"required":["complexity","reason"]}`

// EffortSchema for effort classifier  
const EffortSchema = `{"type":"object","properties":{"effort":{"type":"string","enum":["low","medium","high"]},"reason":{"type":"string"}},"required":["effort","reason"]}`

// PostExecutionSummarySchema for branch/SHA/files extraction
const PostExecutionSummarySchema = `{"type":"object","properties":{"branch_name":{"type":"string"},"commit_sha":{"type":"string"},"files_changed":{"type":"array","items":{"type":"string"}},"summary":{"type":"string"}},"required":["branch_name","commit_sha"]}`
```

Add `extractStructuredOutput(jsonResponse []byte) (json.RawMessage, error)` helper that parses the `--json-schema` wrapper format: `{"result":"...","session_id":"...","structured_output":{...}}` and returns the `structured_output` field.

### 2. Modify `internal/executor/complexity_classifier.go`

- Add `useStructuredOutput bool` field to classifier struct
- When enabled, change args (lines 143-148):
  ```go
  args := []string{"--print", "-p", prompt, "--model", c.model, "--output-format", "json", "--json-schema", ClassificationSchema}
  ```
- Add `parseStructuredClassification()` that uses `extractStructuredOutput()` then unmarshals
- Keep `parseClassificationResponse()` as fallback when flag disabled
- Wire flag from `ClaudeCodeConfig.UseStructuredOutput`

### 3. Modify `internal/executor/effort_classifier.go`

Same pattern as complexity classifier.

### 4. Modify `internal/executor/backend.go` (line 387)

Add to `ClaudeCodeConfig`:
```go
UseStructuredOutput bool `yaml:"use_structured_output,omitempty"`
```

### 5. Modify `internal/executor/runner.go`

Add post-execution summary step after successful `backend.Execute()`, before PR creation (~line 1440):
- Only when `UseStructuredOutput` is enabled
- Run `claude --print -p "Report git state: run 'git log --oneline -1' and 'git branch --show-current' and 'git diff --name-only HEAD~1'. Return branch name, latest commit SHA, and changed files." --model claude-haiku-4-5-20251001 --output-format json --json-schema PostExecutionSummarySchema`
- Parse result, use as primary source for CommitSHA and BranchName
- Keep existing regex + git fallback as secondary fallback

### Config

```yaml
executor:
  claude_code:
    use_structured_output: true  # default: false
```

## Acceptance Criteria

- [ ] `structured_output.go` with schema constants and `extractStructuredOutput()` helper
- [ ] Complexity classifier uses `--json-schema` when `use_structured_output: true`
- [ ] Effort classifier uses `--json-schema` when `use_structured_output: true`
- [ ] Post-execution summary extracts branch/SHA/files via structured output
- [ ] Existing behavior preserved when flag is `false`
- [ ] `make test` passes
- [ ] `make build` succeeds

## Planned Steps (execute all in sequence)

1. **feat(executor): structured output for classifiers + post-execution summary** — Create `structured_output.go` with JSON Schema constants (`ClassificationSchema`, `EffortSchema`, `PostExecutionSummarySchema`) and `extractStructuredOutput()` helper that parses the `--json-schema` wrapper format. Add `UseStructuredOutput bool` field to `ClaudeCodeConfig`. Modify `ComplexityClassifier` to use `--output-format json --json-schema` args and `parseStructuredClassification()` when the flag is enabled, keeping existing `parseClassificationResponse()` as fallback. Apply the same pattern to `EffortClassifier`. Add post-execution summary step in `runner.go` after successful `backend.Execute()` that runs a structured-output Claude call to extract branch name, commit SHA, and changed files, using the result as primary source with existing regex/git fallback as secondary. Add tests for the new helper, updated classifiers, and post-execution summary. Ensure `make test` and `make build` pass.


## Acceptance Criteria

