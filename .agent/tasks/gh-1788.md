# GH-1788

**Created:** 2026-02-24

## Problem

GitHub Issue #1788: refactor(comms): Create Transport layers and wire comms.Handler into main.go

## Follow-up: Comms Module Migration (was GH-1762 + GH-1763 + GH-1764)

Previous PRs for transports and wiring were closed or merged partially. No `transport.go` files exist on main. The adapter handlers are still 1943 (Telegram) and 998 (Slack) lines.

**Depends on:** GH-1786 (shared Handler) and GH-1787 (Messengers) must be merged first.

## Task

Create platform-specific Transport layers that normalize events to `comms.IncomingMessage`, then wire everything through `comms.Handler` in `cmd/pilot/main.go`.

## Changes

### 1. Create `internal/adapters/telegram/transport.go` (~150 lines)

```go
type Transport struct {
    client     *Client
    handler    *comms.Handler
    allowedIDs map[int64]bool
    // voice/photo config
}

func NewTransport(client *Client, handler *comms.Handler, cfg *TransportConfig) *Transport
func (t *Transport) StartPolling(ctx context.Context) error
func (t *Transport) processUpdate(ctx context.Context, update *Update)
// Normalizes: Telegram Update → comms.IncomingMessage → handler.HandleMessage
// Handles voice transcription and photo download before normalization
```

### 2. Create `internal/adapters/slack/transport.go` (~80 lines)

```go
type Transport struct {
    socketClient    *SocketModeClient
    handler         *comms.Handler
    allowedChannels map[string]bool
    allowedUsers    map[string]bool
}

func NewTransport(socket *SocketModeClient, handler *comms.Handler, cfg *TransportConfig) *Transport
func (t *Transport) StartListening(ctx context.Context) error
func (t *Transport) processEvent(ctx context.Context, event *SocketEvent)
// Normalizes: SocketEvent → comms.IncomingMessage → handler.HandleMessage
```

### 3. Shrink adapter handlers

- `telegram/handler.go`: 1943 → ~200 lines (just NewHandler wiring + Telegram-specific config)
- `slack/handler.go`: 998 → ~100 lines (just NewHandler wiring + Slack-specific config)
- All intent handlers, task lifecycle, command routing → removed (now in comms.Handler)

### 4. Update `cmd/pilot/main.go` wiring

Both adapters follow same pattern:
```go
messenger := telegram.NewTelegramMessenger(client, plainTextMode)
commsHandler := comms.NewHandler(&comms.HandlerConfig{
    Messenger: messenger, Runner: runner, Store: store, ...
})
transport := telegram.NewTransport(client, commsHandler, transportConfig)
go transport.StartPolling(ctx)
```

Memory store wired once in `comms.HandlerConfig.Store` — both adapters get it.

## Verification

- `make build` compiles
- `make test` passes
- `make lint` clean
- Manual `--telegram`: all 20 commands work, task execution works, voice/photo work
- Manual `--slack`: all 20 commands work (previously 0), task execution works
- Manual `--telegram --slack`: both work independently

## Scope

This is the final integration step. After this, the comms refactor is complete.

## Acceptance Criteria

