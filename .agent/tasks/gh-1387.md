# GH-1387

**Created:** 2026-02-16

## Problem

GitHub Issue #1387: feat(executor): load Navigator project context into execution prompt

## Context

Pilot executes tasks completely blind to Navigator's accumulated project knowledge. When a human developer uses Navigator, they run `/nav-start` which loads DEVELOPMENT-README.md (key files, feature matrix, architecture), can query SOPs, and reads system docs on-demand. Pilot gets none of this — just the GitHub issue title/description and hardcoded workflow instructions.

This is the **pre-execution** half of closing the Pilot-Navigator context gap.

## Implementation

### 1. Add `loadProjectContext()` to prompt_builder.go

**File:** `internal/executor/prompt_builder.go`

Read `.agent/DEVELOPMENT-README.md` and extract the most valuable sections:

- **Key Components table** — what exists and its status (~500 tokens)
- **Key Files section** — file paths and purposes (~800 tokens)
- **Project Structure** — directory layout (~300 tokens)
- **Current Version** — version number and recent completions (~200 tokens)

Call in `BuildPrompt()` after PILOT EXECUTION MODE header, before task description:

```go
if useNavigator {
    sb.WriteString("## PILOT EXECUTION MODE\n\n")
    // ... existing override text ...

    // NEW: Inject project context
    if projectCtx := loadProjectContext(agentDir); projectCtx != "" {
        sb.WriteString("## Project Context\n\n")
        sb.WriteString(projectCtx)
        sb.WriteString("\n\n")
    }

    sb.WriteString(fmt.Sprintf("## Task: %s\n\n", task.ID))
}
```

**Token budget**: ~2,000 tokens added. Current prompt is ~5,000, total becomes ~7,000. Leaves 121,000 for execution.

### 2. Update INIT phase in workflow.go

**File:** `internal/executor/workflow.go`

Update Phase 1 (INIT) to instruct Claude to load `.agent/` docs:

```
### Phase 1: INIT (0-10%)

**Do**:
- Read the full task description
- Identify acceptance criteria
- Note any constraints mentioned
- Read `.agent/DEVELOPMENT-README.md` for project context (key files, architecture)
- Check `.agent/sops/` for SOPs relevant to this task type
- If task touches integrations, read the matching SOP in `.agent/sops/integrations/`

**Don't**:
- Start coding immediately
- Skip reading requirements
- Ignore existing project documentation
```

### 3. Add `findRelevantSOPs()` to prompt_builder.go

Scan `.agent/sops/` for files matching task keywords:

```go
func findRelevantSOPs(agentDir string, taskDescription string) []string {
    // Walk .agent/sops/ subdirectories
    // Match filenames against task keywords (simple string matching)
    // Return up to 3 relevant SOP file paths
}
```

Include as hints in prompt (paths only, not full content — Claude reads them during RESEARCH phase):

```
## Relevant SOPs
Check these before implementing:
- `.agent/sops/debugging/sqlite-busy.md` (matches: sqlite)
```

### 4. Tests

**File:** `internal/executor/prompt_builder_test.go`

- Test `loadProjectContext()` with mock `.agent/DEVELOPMENT-README.md`
- Test `findRelevantSOPs()` keyword matching
- Test BuildPrompt includes project context when `.agent/` exists
- Test trivial tasks still skip Navigator overhead

## Acceptance Criteria

- [ ] BuildPrompt includes project context (key files, components, structure) from DEVELOPMENT-README.md
- [ ] INIT phase instructions tell Claude to read `.agent/` docs for additional context
- [ ] SOP hints appear in prompt when task keywords match SOP filenames
- [ ] Trivial tasks still skip Navigator overhead (existing behavior preserved)
- [ ] `make test && make lint` passes

## Files to Modify

| File | Change |
|------|--------|
| `internal/executor/prompt_builder.go` | Add `loadProjectContext()`, `findRelevantSOPs()`, inject into BuildPrompt |
| `internal/executor/workflow.go` | Update INIT phase to instruct reading `.agent/` docs |
| `internal/executor/prompt_builder_test.go` | Tests for context loading and SOP matching |

## Planned Steps (execute all in sequence)

1. **Implement Navigator project context loading, SOP discovery, workflow INIT update, and tests** — All changes live in `internal/executor/` and must ship as a single unit.
**Scope:**
- Add `loadProjectContext(agentDir string) string` to `prompt_builder.go` — reads `.agent/DEVELOPMENT-README.md`, extracts Key Components table (~500 tokens), Key Files section (~800 tokens), Project Structure (~300 tokens), Current Version (~200 tokens). Total ~2,000 token budget.
- Add `findRelevantSOPs(agentDir string, taskDescription string) []string` to `prompt_builder.go` — walks `.agent/sops/` subdirectories, matches filenames against task keywords via simple string matching, returns up to 3 relevant SOP file paths.
- Inject both into `BuildPrompt()` in the full-Navigator path (Path A, after the "PILOT EXECUTION MODE" header, before the task description block around line 50). Include project context as `## Project Context` section and SOP hints as `## Relevant SOPs` section.
- Update `workflow.go` INIT phase const (lines 40-53) to add instructions: read `.agent/DEVELOPMENT-README.md` for project context, check `.agent/sops/` for relevant SOPs, read matching integration SOPs if task touches integrations.
- Create `prompt_builder_test.go` with table-driven tests: `loadProjectContext()` with mock `.agent/DEVELOPMENT-README.md`, `findRelevantSOPs()` keyword matching (positive and negative cases), `BuildPrompt()` includes project context when `.agent/` exists, trivial tasks still skip Navigator overhead (existing behavior preserved).
- Verify: `make test && make lint` passes.


## Acceptance Criteria

