# GH-1316

**Created:** 2026-02-15

## Problem

GitHub Issue #1316: fix(executor): Qwen Code backend bugs — pricing, version check, resume fallback

## Summary

Post-ship review of Qwen Code backend (GH-1315, v1.9.0) found 5 bugs. Fix all in this PR.

## Bugs to Fix

### 1. Qwen3-Coder-Plus Pricing 5x Underpriced (Critical)

**File**: `internal/executor/runner.go` ~line 3251-3263

Current code has Plus at `$0.22/$1.00` (input/output per 1M tokens). Actual Alibaba Cloud International pricing is `$1.00/$5.00`. Flash pricing ($0.30/$1.50) is correct.

**Fix**: Change Plus pricing:
```go
case strings.Contains(modelLower, "480b") || strings.Contains(modelLower, "plus"):
    inputPrice = 1.00  // Qwen3-Coder-Plus (International, 0-32K)
    outputPrice = 5.00
```

### 2. No CLI Version Check in `IsAvailable()` (Medium)

**File**: `internal/executor/backend_qwencode.go` ~line 172-176

`IsAvailable()` only checks `exec.LookPath` — doesn't validate the installed Qwen CLI supports `--output-format stream-json` (requires v0.1.0+).

**Fix**: Run `qwen --version`, log the result. **Warn only, don't hard-gate** — preview release version strings are unpredictable. Let execution fail naturally if incompatible.

```go
func (b *QwenCodeBackend) IsAvailable() bool {
    path, err := exec.LookPath(b.config.Command)
    if err != nil {
        return false
    }
    out, err := exec.Command(path, "--version").Output()
    if err != nil {
        b.log.Warn("qwen-code: could not determine version", "error", err)
        return true
    }
    version := strings.TrimSpace(string(out))
    b.log.Info("qwen-code: detected version", "version", version)
    return true
}
```

### 3. Missing Test for `content` Field in tool_result (Low)

**File**: `internal/executor/backend_qwencode_test.go`

The Qwen parser checks `block.Content` before `block.Text` for tool_result blocks (lines 514-518 of backend_qwencode.go), but only the `text` path is tested. Add test case:

```go
{
    name: "tool_result with content field",
    input: `{"type":"user","message":{"content":[{"type":"tool_result","content":"file contents here","is_error":false}]}}`,
    expected: StreamEvent{Type: EventTypeToolResult, ToolResult: "file contents here"},
},
```

### 4. Missing `session_not_found` Error Type (Low)

**File**: `internal/executor/backend_qwencode.go`

Add `QwenErrorTypeSessionNotFound` constant and detect it in `classifyQwenCodeError()`:

```go
QwenErrorTypeSessionNotFound QwenCodeErrorType = "session_not_found"
```

In classifier:
```go
case strings.Contains(stderrLower, "session not found") ||
     strings.Contains(stderrLower, "session expired") ||
     strings.Contains(stderrLower, "invalid session"):
    return QwenErrorTypeSessionNotFound
```

### 5. No `--resume` Failure Fallback (Low)

**File**: `internal/executor/backend_qwencode.go`

When `--resume` fails with `session_not_found`, retry without `--resume`. Mirrors Claude backend's `--from-pr` fallback pattern (`backend_claudecode.go` lines 190-206).

In `Execute()`, after error classification:
```go
if qErr.Type == QwenErrorTypeSessionNotFound && opts.ResumeSessionID != "" {
    b.log.Warn("qwen-code: session not found, retrying without --resume",
        "session_id", opts.ResumeSessionID)
    opts.ResumeSessionID = ""
    return b.Execute(ctx, opts)
}
```

## Verification

```bash
go build ./...
go test ./internal/executor/... -v -count=1
go vet ./internal/executor/...
```

## Files to Modify

- `internal/executor/runner.go` — Fix Plus pricing
- `internal/executor/backend_qwencode.go` — Version check, session_not_found, resume fallback
- `internal/executor/backend_qwencode_test.go` — Add content field test, version check test

## Acceptance Criteria

